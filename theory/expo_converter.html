<h1>Exponential convertion - the useful formulas</h1>
<p>
    The exponential converter / logarithmic converter is a very useful circuit, used for
    converting a linear CV to a logarithmic current in analog synthesizer VCOs and VCAs etc. Single
    transistor exponential converters are terribly temperature sensitive, so a dual transistor
    scheme
    that compensates for many of the temperature effects is often used.
</p>
<p>
    This article describes four different variations of this circuit. I have seen several articles
    saying that you can change what transistor to connect the reference current to, and what base to
    use for controlling the converter. This text explains how. I will not
    go into details about how they compensate for temperature variations (see here for a discussion
    of this), but I will give you the necessary formulas and explain how I arrived at them.
</p>
<p>
    The four configurations are:
<ul>
    <li>A: Falling positive exponential (starting high positive and falling to close to 0)</li>
    <li>B: Rising positive exponential (starting close to 0 and rising to high positive)</li>
    <li>C: Rising negative exponential (starting close to 0 and rising to high negative)</li>
    <li>D: Falling negative exponential (starting high negative and falling to close to 0)</li>
</ul>
</p>
<p>
    The four plots are derived from the same -100mV to +100mV control voltage (CV).
</p>
<p>
    The test circuit looks like this:
</p>

<p>
    There are only tiny variations in the circuits:
<ul>
    <li>For each exponential converter, a reference current is connected to the left transistor's
        collector.
    </li>
    <li>A and C have the CV connected to the right transistor's base (the other is grounded)</li>
    <li>B and D have the CV connected to the left transistor's base (the other is grounded)</li>
    <li>A and B are PNP transistors. For these, the reference current must be negative, i.e. flow
        out
        of the transistor's collector.
    </li>
    <li>A and B are NPN transistors. For these, the reference current must be positive, i.e. flow
        into
        the transistor's collector.
    </li>
</ul>
</p>

<p>
    These are the formulas for the four exponential converters:
<ul>
    <li>A: I_out = I_ref * e^(-V_cv/V_T), I_ref < 0</li>
    <li>B: I_out = I_ref * e^(V_cv/V_T), I_ref < 0</li>
    <li>C: I_out = I_ref * e^(V_cv/V_T), I_ref > 0</li>
    <li>D: I_out = I_ref * e^(-V_cv/V_T), I_ref > 0</li>
</ul>
</p>
<p>
    I_ref is generated by the 1.5MOhm resistors connected to + or - 15V in the test circuit.
    Let's call the resistor R_ref and the voltage V_ref.
</p>
<p>
    The reference current I_ref is then:

    I_ref = V_ref/R_ref

    or 1.5MOhm/15V = 10uA for C and D, 1.5MOhm/-15V = -10uA for A and B.
</p>
<h2>Things to consider</h2>
<p>
<ul>
    <li>The output of the converter is a current, not a voltage</li>
    <li>The reference current sets the output current when V_cv = 0</li>
    <li>
        The output current is doubled/halved by increasing/decreasing V_cv by approx 17.5mV. The
        exact
        value is temperature dependent. Doubling or halving the current is important, as a frequency
        increase of one octave is equal to doubling the frequency.
    </li>
    <li>
        Build the pre-V_cv-input circuitry to produce a 17.5mV response that matches your wanted CV
        response - e.g. if your input CV is 0 to 5V and you want a 1oct/V response, you need to make
        a
        circuit with V_out = V_in * 0.0175
    </li>
    <li>
        Add or subtract a voltage from the input CV to trim the starting points of octaves (tune a
        note)
    </li>
    <li>Adjust the division circuitry/attenuation factor (4) to adjust the V/oct (adjusts
        tracking)
    </li>
    <li>The voltage at the collector of the right transistor, V_c_2, cannot be determined by looking
        at the exponential converter alone - it depends on whatever you put after the converter.
        However,
        for the transistor to conduct, V_c must be at least 0.25V (approx) larger than V_e for the
        NPN
        configuration, and V_c must be at least 0.25V (approx) less than V_e for the PNP
        configuration.
        This limits the maximum I_out, see example at the end.
    </li>
</ul>
</p>

<h2>
    Now for some facts and background information
</h2>
<p>
    Two transistors with connected emitters have the same V_e.
</p>
<p>
    The collector current I_c is always directly related to V_be through the Ebers Moll equations.
    If one changes, the other changes. The only way V_be can change is if I_c also changes
    (and thus, changing V_be changes I_c).
</p>
<p>
    A constant I_ref is generated by connecting a resistor R_ref between a known, constant voltage
    and
    the collector of one of the transistors. The transistor is then placed within the feedback loop
    of an opamp, with the collector connected to the negative input and the emitter connected
    (through a resistor) to the opamp output. As the collector is now at virual ground, the current
    flowing through R_ref is V_ref / R_ref. This same current flows through the collector, as the
    opamp tries to make the sum of currents into its inputs zero.
</p>
<p>
    Now let's figure out the exact formulas for the relationship between the two transistors' V_b
    and I_c:
</p>
<p>
    The Ebers-Moll equation for an NPN transistor can be approximated as
</p>
<p>
    I_c = I_s * e^(V_be/V_T).
</p>
<p>
Rearranging for V_be gives us
</p>
<p>
    V_be = V_T * ln(I_c/I_s)
</p>

Here's a little trick. Since V_e is the same for both transistors, the difference in V_be between
the two transistors can be written as

dV_be = V_be_2 - V_be_1
= (V_b_2 - V_e) - (V_b_1 - V_e)
= V_b_2 - V_b_1

Also

dV_be = V_t * ln(I_c_2/I_s) - V_t * ln(I_c_2/I_s
= V_t(ln(I_c_2/I_s) -ln(I_c_2/I_s)
= V_T * ln(I_c_2/I_c_1)

So we get

V_b_2 - V_b_1 = V_T * ln(I_c_2/I_c_1)
ln(I_c_2/I_c_1) = (V_b_2 - V_b_1)/V_T
I_c_2/I_c_1 = e^((V_b_2 - V_b_1)/V_T)

For NPN:
I_c_2 = I_c_1 * e^((V_b_2 - V_b_1)/V_T)


The Ebers-Moll equation for a PNP transistor on the other hand can be approximated as

I_c = I_s * e^(V_eb/V_T). * explain where I found this -- http://www.jaegerblalock.com/
-- Microelectronic Circuit Design by Travis Blalock, Richard Jaeger

Rearranging for V_be gives us

V_eb = V_T * ln(I_c/I_s)

Then the same trick: Since V_e is the same for both transistors, the difference in V_be between the
two transistors can be written as

dV_eb = V_eb_2 - V_eb_1
= (V_e - V_b_2) - (V_e - V_b_1)
= -V_b_2 + V_b_1
= V_b_1 + V_b_2

Similarly,

dV_eb = V_t * ln(I_c_2/I_s) - V_t * ln(I_c_2/I_s
= V_t(ln(I_c_2/I_s) -ln(I_c_2/I_s)
= V_T * ln(I_c_2/I_c_1)

So we get

V_b_1 - V_b_2 = V_T * ln(I_c_2/I_c_1)
ln(I_c_2/I_c_1) = (V_b_1 - V_b_2)/V_T
I_c_2/I_c_1 = e^((V_b_1 - V_b_2)/V_T)

For PNP:
I_c_2 = I_c_1 * e^((V_b_1 - V_b_2)/V_T)


We now have the formulas for both PNP and NPN transistors. They say nothing about which one of
the collectors are to be considered the reference current, nor which one, if any of, the bases
are grounded or which one is the control input. If we want to find I_c_1 based on I_c2 instead,
we just negate the exponent:

a = b * e^x => b = a / e^x = a * 1/e^x = a*e^-x


Before the final transformation into the formulas above, let's stop to think about what is
actually going on in the circuits.

The base of one of the transistors has been grounded in each circuit. Why?

If we ground the base of the transistor that is inside the feedback loop (A, C):
- we now have a transistor with a fixed V_b_1 and a fixed I_c_1 (I_ref). As mentioned, a fixed V_c
means a fixed V_be, and since V_b is also fixed, V_e will be constant. It cannot go anywhere.
- therefore, as we change V_b_2 (the CV), V_be_2 will change, and I_c_2 (I_out) changes.

If we ground the base of the transistor connected to the output:
- The transistor inside the feedback loop still has a fixed I_c_1, which means that V_be_1 is
also fixed. But now the CV is connected to the base, i.e. V_b_1 is variable. Thus, to keep I_c_1
constant, V_e must also change.
- the other transistor however, has its base grounded. V_b_2 is constant. Now, as V_b_1 changes,
V_e changes. This in turn changes V_be_2, and as V_be_2 changes, I_c_2
(I_out) changes.

Thus, we can control I_out by changing either one of the bases and keeping the other fixed.


The final transformation

For A:
A is a PNP configuration, so we'll use

I_c_2 = I_c_1 * e^((V_b_1 - V_b_2)/V_T)

I_c_2 = I_out, I_c_1 = I_ref, V_b_1 = 0 (grounded) and V_b_2 is our control, V_cv. Thus we're
left with

I_out = I_ref * e^(-V_cv/V_T)

For B:
B is also a PNP configuration, so we'll use

I_c_2 = I_c_1 * e^((V_b_1 - V_b_2)/V_T)

I_c_2 = I_out, I_c_1 = I_ref, V_b_2 = 0 (grounded) and V_b_1 is our control, V_cv. Thus we're
left with

B: I_out = I_ref * e^(V_cv/V_T)

For C:
C is an NPN configuration, so we'll use

I_c_2 = I_c_1 * e^((V_b_2 - V_b_1)/V_T)

I_c_2 = I_out, I_c_1 = I_ref, V_b_1 = 0 (grounded) and V_b_2 is our control, V_cv. Thus we're
left with

C: I_out = I_ref * e^(V_cv/V_T)

For B:
B is also an NPN configuration, so we'll use

I_c_2 = I_c_1 * e^((V_b_2 - V_b_1)/V_T)

I_c_2 = I_out, I_c_1 = I_ref, V_b_2 = 0 (grounded) and V_b_1 is our control, V_cv. Thus we're
left with

D: I_out = I_ref * e^(-V_cv/V_T)


Max I_out

As mentioned, V_c_2 is determined by I_out and the circuit after the collector. Let's look at an
example:

Here, I_out is fed through an 18k resistor. Following Ohms law, the voltage across the resistor
has to be U = R*I = 18kOhm * I_out. As the bottom of the resistor is tied to -15V, the side
connected to the collector must have a voltage V_c_2 = -15V + 18kOhm * I_out.

As also mentioned, V_c for a PNP transistor must be at least 0.25V less than V_e. It is thus the
value of V_e that limits the maximum I_out:

I_out_max = ((V_e - 0.25) + 15V) / 18kOhm, and V_e is a result of I_ref.

R_e

R_e limits the current that flows into the constant current-generator op amp. To keep the current
constant, it has to sink (or source) exactly I_ref + I_out. It does this by moving its output
voltage up and down. The voltage across R_e follows Ohms law, V_e = R_e * I_e = R_e * (I_ref +
I_out). When V_e gets too large, the opamp cannot pull its output further up or down, and I_out
cannot get any higher. The smaller the value for R_e, the less voltage across it.

TODO: How to select a good value.